# 1. Redis 应用实践

## 1.1. 分布式锁

- 注意点
  - 原子加锁 set nx px
  - 超时时间设置 避免删除锁得不到执行导致死锁
  - 业务逻辑避免时间过长导致超时 ==> 释放锁其它线程得到执行
  - 可重入锁 ==> ThreadLocal
  - 锁冲突
    - 业务中断结束
    - 重试机制,等待指定间隔时间再重新获取锁
    - 请求转移至延迟队列
- 实现
  - redLock
  - redission

## 1.2. 布隆过滤器

&emsp;&emsp;布隆过滤器可以理解为一个不怎么精确的 set 结构，当你使用它的 contains 方法判断某个对象是否存在时，它可能会误判。但是布隆过滤器也不是特别不精确，只要参数设置的合理，它的精确度可以控制的相对足够精确，只会有小小的误判概率.<br>
&emsp;&emsp;当布隆过滤器说某个值存在时，这个值可能不存在；当它说不存在时，那就肯定不存在.

- 原理-rebloom 模块

  - 多次哈希 ==> Bitmap 维护落点位置 ==> 0 和 1
  - 如果有一个落点位为 0 则不存在,否则可能存在

- 注意点
  - 允许误差

## 1.3. 限流

- 注意点
  - 滑动窗口算法
    - zset score 存储时间撮
    - 删除指定时间内 zset 中的数据
    - 统计 zset 中总量是否达到临界值
    - 并发量大的情况下 接口限流过多导致占用内存很大 ==> 不适合限流量大的操作
  - 漏斗限流: redis-cell 模块
    - 初始容量大小
    - 维护时间撮
    - 待处理容量
    - 处理速率
    - 过程
      - 请求进来计算时间差\*速率=可以处理的数量
      - 数量大于 0 ==> 接受请出去 ==> 更新时间撮和待处理容量

## 1.4. 消息队列

### 异步消息队列

- 注意点
  - List rpop lpop rpush lpush
  - blpop brpop 当队列为空阻塞等待
  - 空闲连接自动断开 ==> 异常捕获处理

### 延迟消息队列

## 1.5. 基数统计法 HyperLogLog

&emsp;&emsp;基数统计数适用于对精度要求允许误差,进行大批量数据统计的业务场景, 对比传统的线程统计在性能和内存占用上有着明显的优势.

- 视频/文章/网页的浏览量

## 1.6. 会话缓存

&emsp;&emsp;使用 Redis 进行 Session 托管,解决分布式系统的统一会话管理.

- 集群环境下的 seesion 共享问题解决方案
  - 粘性 session: 指 Ngnix 每次都将同一用户的所有请求转发至同一台服务器上，即将用户与服务器绑定。
  - 服务器 session 复制: 每次 session 发生变化时，创建或者修改，就广播给所有集群中的服务器，使所有的服务器上的 session 相同。
  - session 共享: 缓存 session，使用 redis， memcached。
  - session 持久化: 将 session 存储至数据库中，像操作数据一样才做 session

## 1.7. 排行榜/计数器

## 1.8. 发布/订阅

## 1.9. 高可用机制

主从、哨兵、集群

## 1.10. 事物管理

## 1.11. 持久化机制

## 1.12. 管道命令

## 1.13. 虚拟内存使用
