# 架构设计 专题

## 1. 设计思想 :id=design-thinking

### 1.1. OO 设计思想 :id=thinking-in-oo

?> OO(Object oriented)设计思想的总纲则面向对象，主要有`OOA`、`OOD`、`OOP`这几个方面。

#### 1.1.1. OOA（Analysis：面向对象分析） :id=thinking-in-ooa

?> 面向对象分析方法（Object-Oriented Analysis，OOA），是在一个系统的开发过程中进行了系统业务调查以后，按照面向对象的思想来分析问题。

- 分析层次
  - 主题层
  - 对象类层
  - 结构层
  - 属性层
  - 服务层
- 分析活动
  - 标识对象类
  - 标识结构
  - 定义主题
  - 定义属性
  - 定义服务

#### 1.1.2. OOD（Design：面向对象设计） :id=thinking-in-ood

?> 面向对象设计（Object-Oriented Design，OOD）方法是 OO 方法中一个中间过渡环节。其主要作用是对 OOA 分析的结果作进一步的规范化整理，以便能够被 OOP 直接接受。
OOD 就是“根据需求决定所需的类、类的操作以及类之间关联的过程”。

- 面向对象编程范式
  - 决定你要的类；
  - 给每个类提供完整的一组操作；
  - 明确地使用继承来表现共同点。

#### 1.1.3. OOP（Programming：面向对象编程） :id=thinking-in-oop

?> 面向对象编程遵循`封装`、`继承`、`多态`几大要素。

## 2. 分布式系统 :id=distributed-systems

### 2.1. 基础概念

?> 分布式应用程序就是指应用程序分布在不同计算机上，通过网络来共同完成一项任务，通常为服务器/客户端模式。

#### 2.1.1. 三元组

?> 分布式系统说白了，就是很多机器组成的集群，靠彼此之间的网络通信，担当的角色可能不同，共同完成同一件事情的系统。

![](/assets/images/architecture-design/20220318015435.png '::class=center :size=60%')

- 按照实体划分
  - 节点：系统中按照协议完成计算工作的一个逻辑实体，可能是执行某些工作的进程或机器
  - 网络：系统的数据传输通道，用来彼此通信。通信是具有方向性的。
  - 存储：系统中持久化数据的数据库或者文件存储。

#### 2.1.2. 状态特性

?> 各个节点的状态可以是“无状态”或者“有状态的”。
&emsp;&emsp;一般认为，节点是偏计算和通信的模块，一般是无状态的。这类应用一般不会存储自己的中间状态信息，比如 Nginx，一般情况下是转发请求而已，不会存储中间信息。另一种“有状态”的，如 mysql 等数据库，状态和数据全部持久化到磁盘等介质。
&emsp;&emsp;“无状态”的节点一般我们认为是可随意重启的，因为重启后只需要立刻工作就好。“有状态”的则不同，需要先读取持久化的数据，才能开始服务。所以，“无状态”的节点一般是可以随意扩展的，“有状态”的节点需要一些控制协议来保证扩展。

#### 2.1.3. 系统异常

?> 异常，可认为是节点因为某种原因不能工作，此为节点异常。还有因为网络原因，临时、永久不能被其他节点所访问，此为网络异常。在分布式系统中，要有对异常的处理，保证集群的正常工作。

#### 2.1.4. 分布式系统有什么作用

- 分散服务器压力

- 提供服务，功能复用


#### 2.1.5. 分布式系统架构有哪些考虑点

?> 分布式应用程序的开发，要对应用程序进行分层，各层之间相互独立，通过服务或接口来进行调用，不仅便于开发的管理，也有利于集成其他平台上的应用程序，实现了功能模块的复用、重用，提高了应用程序的可扩展性。
在业务数据量多的情况下，还要考虑构建分布式的数据库系统，这可以通过 DBMS 自动管理的数据订阅、分发技术实现数据库的数据同步，以达到数据共享的目的；

- 分层模型

- 面向服务

- 分布式数据库

### 2.2. 分布式系统特性

#### 2.2.1. CAP理论

- 一致性：描述当前所有节点存储数据的统一模型。
    - 强一致性：描述了所有节点的数据高度一致，无论从哪个节点读取，都是一样的。
    - 弱一致性
        - 单调一致性：强调数据是按照时间的新旧，单调向最新的数据靠近，不会回退。
        - 最终一致性：强调数据经过一个时间窗口之后，只要多尝试几次，最终的状态是一致的，是最新的数据。

- 可用性

?> 保证系统的正常可运行性，在请求方看来，只要发送了一个请求，就可以得到恢复无论成功还是失败（不会超时）。

- 分区容错性

?> 在系统某些节点或网络有异常的情况下，系统依旧可以继续服务。
通常是有负载均衡和副本来支撑的。例如计算模块异常可通过负载均衡引流到其他平行节点，存储模块通过其他几点上的副本来对外提供服务。


>[!COMMENT]扩展性：扩展性是融合在CAP里面的特性。
 扩展性直接影响了分布式系统的好坏，系统开发初期不可能把系统的容量、峰值都考虑到，后期肯定牵扯到扩容，而如何做到快而不太影响业务的扩容策略，也是需要考虑的。

#### 2.2.2. BASE定理

### 2.3. 分布式系统设计策略

#### 2.3.1. 重试机制

?> 防止网络抖动或者服务器短暂实践停止服务导致业务请求中断，增加重试机制并指定合理的重试间隔时间和重试次数，可以提高系统的可用性。

#### 2.3.2. 心跳机制

?> 心跳机制主要是为了双方节点间的健康状态的检查，以固定频率地方式发送心跳包，来确保彼此间的通信正常。

#### 2.3.3. 副本

?>  副本指的是针对一份数据的多份冗余拷贝，在不同的节点上持久化同一份数据，当某一个节点的数据丢失时，可以从副本上获取数据。数据副本是分布式系统解决数据丢失异常的仅有的**唯一途径**。

#### 2.3.4. 中心化/去中心化

?> 中心化与去中心化是系统模型的两种体现。

- 中心化：有1个或几个节点充当整个系统的核心元数据及节点管理工作，其他节点都和中心节点交互。
    - 优点：数据和管理高度统一集中在一个地方，容易聚合。
    - 缺点：模块高度集中，容易形成性能瓶颈，并且如果出现异常，就像群龙无首一样。

- 去中心化：系统中不存在一个领导者，节点彼此通信并且彼此合作完成任务。
    - 优点：出现异常，不会影响整体系统，局部不可用。
    - 缺点：比较协议复杂，而且需要各个节点间同步信息。


### 2.4. 分布式系统设计实践

#### 2.4.1. 数据分布

?> 在分布式系统中，无论是计算还是存储，处理的对象都是数据，数据不存在于一台机器或进程中，这就牵扯到如何多机均匀分发数据的问题。
常用的解决方案有：`哈希取模`、`一致性哈希`、`范围表划分`、`数据块划分`。

##### 2.4.1.1. 哈希取模

?> 将数据对象通过哈希函数计算哈希值，将哈希值与对应数据存储节点位置取模运算获取到数据的落点节点，再从对应节点对进行数据的处理。
这样的好处是只需要通过计算就可以映射出数据和处理节点的关系，不需要存储映射。难点就是如果id分布不均匀可能出现计算、存储倾斜的问题，在某个节点上分布过重。
并且当处理节点宕机时，这种”硬哈希“的方式会直接导致部分数据异常，还有扩容非常困难，原来的映射关系全部发生变更。

##### 2.4.1.2. 一致性哈希

?> 一致性哈希(Consistent Hash)是一种特殊的哈希算法，目的是解决分布式缓存的问题。
在移除或者添加一个服务器时，能够尽可能小地改变已存在的服务请求与处理请求服务器之间的映射关系。一致性哈希解决了简单哈希算法在分布式哈希表( Distributed Hash Table，DHT) 中存在的动态伸缩等问题。

![](/assets/images/architecture-design/20220318121541.png ':class=center :size=60%')

- 原理

?> 一致性哈希算法将整个哈希值空间映射成一个虚拟的圆环，整个哈希空间的取值范围为0~232-1。整个空间按顺时针方向组织。0~232-1在零点中方向重合。
接下来使用如下算法对服务请求进行映射，将服务请求使用哈希算法算出对应的hash值，然后根据hash值的位置沿圆环顺时针查找，第一台遇到的服务器就是所对应的处理请求服务器。当增加一台新的服务器，受影响的数据仅仅是新添加的服务器到其环空间中前一台的服务器（也就是顺着逆时针方向遇到的第一台服务器）之间的数据，其他都不会受到影响。
综上所述，一致性哈希算法对于节点的增减都只需重定位环空间中的一小部分数据，具有较好的容错性和可扩展性。

##### 2.4.1.3. 数据范围表划分

?> 业务数据分布不均匀导致不同范围内的数据访问量差异比较严重，这个时候就需要进行数据分组，将小访问量范的数据聚集在一起，根据业务场景按需划分。

!> 数据范围划分后需要额外的存储模块进行数据存储，因此可能对系统的性能和可用性造成一定的影响。

##### 2.4.1.4. 数据块划分

?> 将数据按固定块大小(比如HDFS的64MB)，将数据分为一个个大小固定的块，然后这些块均匀的分布在各个节点，这种做法也需要外部节点来存储映射关系。
由于与具体的数据内容无关，按数据量分布数据的方式一般没有数据倾斜的问题，数据总是被均匀切分并分布到集群中。当集群需要重新负载均衡时，只需通过迁移数据块即可完成。


#### 2.4.2. 副本控制

#### 2.4.3. 高可用协议

### 2.5. 分布式系统部署策略

- 代理服务器实现请求的分离 。
- 缓存的分布式部署，提高系统性能。
- 拆分网站的对外功能，例如不同域名前、后缀，URL 重写。
- 面向服务，每个服务分布到一台服务器上 。
- 数据库的分布式集群部署。
- 设立专门的应用服务器。比如发送邮件通知的服务。